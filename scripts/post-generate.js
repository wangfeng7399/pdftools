#!/usr/bin/env node
/**
 * Post-generate script to create default.js files for Prisma Client
 * This ensures proper module resolution in pnpm environments
 */

const fs = require('fs');
const path = require('path');

const baseDir = path.join(__dirname, '..');

// Find all @prisma/client packages in pnpm structure
function findPrismaClientDirs() {
  const dirs = [];
  const pnpmDir = path.join(baseDir, 'node_modules', '.pnpm');
  
  if (fs.existsSync(pnpmDir)) {
    const entries = fs.readdirSync(pnpmDir);
    for (const entry of entries) {
      if (entry.startsWith('@prisma+client@')) {
        const clientDir = path.join(pnpmDir, entry, 'node_modules', '@prisma', 'client', '.prisma', 'client');
        if (fs.existsSync(clientDir)) {
          dirs.push(clientDir);
        }
      }
    }
  }
  
  // Also check standard location
  const standardDir = path.join(baseDir, 'node_modules', '@prisma', 'client', '.prisma', 'client');
  if (fs.existsSync(standardDir)) {
    dirs.push(standardDir);
  }
  
  return dirs;
}

function createDefaultExports() {
  const clientDirs = findPrismaClientDirs();
  
  clientDirs.forEach(clientDir => {
    const defaultJsPath = path.join(clientDir, 'default.js');
    const defaultDtsPath = path.join(clientDir, 'default.d.ts');
    const clientTsPath = path.join(clientDir, 'client.ts');
    
    if (fs.existsSync(clientTsPath)) {
      // For Next.js, we need to create a default.js that Next.js can handle
      // Next.js will compile TypeScript files, but we need to use a different approach
      // We'll create a minimal wrapper that Next.js can process
      const defaultJsContent = `// This file is auto-generated by post-generate.js
// Next.js will handle TypeScript compilation, so we use a dynamic import approach
// This file is only used during build/runtime, Next.js will handle the actual import
module.exports = {};
`;
      const defaultDtsContent = `export * from './client';
`;
      
      fs.writeFileSync(defaultJsPath, defaultJsContent);
      fs.writeFileSync(defaultDtsPath, defaultDtsContent);
      console.log(`✓ Created default exports in ${clientDir}`);
    }
  });
  
  // Also fix the @prisma/client default.js to point directly to client
  // Find all @prisma/client packages
  const pnpmDir = path.join(baseDir, 'node_modules', '.pnpm');
  const prismaClientDirs = [path.join(baseDir, 'node_modules', '@prisma', 'client')];
  
  if (fs.existsSync(pnpmDir)) {
    const entries = fs.readdirSync(pnpmDir);
    for (const entry of entries) {
      if (entry.startsWith('@prisma+client@')) {
        const pkgDir = path.join(pnpmDir, entry, 'node_modules', '@prisma', 'client');
        if (fs.existsSync(pkgDir)) {
          prismaClientDirs.push(pkgDir);
        }
      }
    }
  }
  
  prismaClientDirs.forEach(pkgDir => {
    const pkgDefaultJs = path.join(pkgDir, 'default.js');
    // In Prisma 6.x, default.js should export from .prisma/client/default
    // In Prisma 7.x, it might be .prisma/client/client
    // Check which one exists relative to the package directory
    const prismaClientDefault = path.join(pkgDir, '.prisma', 'client', 'default');
    const prismaClientClient = path.join(pkgDir, '.prisma', 'client', 'client');
    
    // Also check in .pnpm structure (client is generated in .prisma, not in @prisma/client/.prisma)
    const pnpmPrismaClientDir = path.join(pkgDir, '..', '..', '.prisma', 'client');
    const pnpmDefault = path.join(pnpmPrismaClientDir, 'default');
    
    if (fs.existsSync(pkgDir)) {
      let pkgDefaultContent;
      
      if (fs.existsSync(prismaClientDefault + '.js') || fs.existsSync(prismaClientDefault + '.d.ts')) {
        // Prisma 6.x format - .prisma/client/default exists in package
        pkgDefaultContent = `// This file is auto-generated by post-generate.js
// For Prisma 6.x: default.js should export from .prisma/client/default
module.exports = require('./.prisma/client/default');
`;
      } else if (fs.existsSync(pnpmDefault + '.js') || fs.existsSync(pnpmDefault + '.d.ts')) {
        // Prisma 6.x format - .prisma/client/default exists in .pnpm structure
        // Calculate relative path from @prisma/client to .prisma/client
        const relativePath = path.relative(pkgDir, pnpmPrismaClientDir).replace(/\\/g, '/');
        pkgDefaultContent = `// This file is auto-generated by post-generate.js
// For Prisma 6.x: default.js should export from .prisma/client/default
module.exports = require('${relativePath}/default');
`;
      } else if (fs.existsSync(prismaClientClient + '.js') || fs.existsSync(prismaClientClient + '.d.ts')) {
        // Prisma 7.x format (fallback)
        pkgDefaultContent = `// This file is auto-generated by post-generate.js
// For Prisma 7.x: default.js should export from .prisma/client/client
module.exports = require('./.prisma/client/client');
`;
      } else {
        // Neither exists, use index.js as fallback (which will try to require .prisma/client/default)
        pkgDefaultContent = `// This file is auto-generated by post-generate.js
// Fallback to index.js (which handles .prisma/client/default)
module.exports = require('./index');
`;
      }
      
      fs.writeFileSync(pkgDefaultJs, pkgDefaultContent);
      console.log(`✓ Updated package default.js in ${pkgDir}`);
    }
  });
}

createDefaultExports();
